<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Phoebe Jiang (phoebe.jiang@biogen.com)">
<meta name="dcterms.date" content="2024-09-16">

<title>Example code of the simulations conducted in Jiang et al.&nbsp;2024</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="runme_files/libs/clipboard/clipboard.min.js"></script>
<script src="runme_files/libs/quarto-html/quarto.js"></script>
<script src="runme_files/libs/quarto-html/popper.min.js"></script>
<script src="runme_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="runme_files/libs/quarto-html/anchor.min.js"></script>
<link href="runme_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="runme_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="runme_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="runme_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="runme_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#manuscript" id="toc-manuscript" class="nav-link active" data-scroll-target="#manuscript">Manuscript</a></li>
  <li><a href="#how-to-run-the-simulations-described-in-the-paper-yourself" id="toc-how-to-run-the-simulations-described-in-the-paper-yourself" class="nav-link" data-scroll-target="#how-to-run-the-simulations-described-in-the-paper-yourself">How to run the simulations described in the paper yourself?</a>
  <ul class="collapse">
  <li><a href="#an-example" id="toc-an-example" class="nav-link" data-scroll-target="#an-example">An Example</a></li>
  <li><a href="#result-visualization" id="toc-result-visualization" class="nav-link" data-scroll-target="#result-visualization">Result visualization</a>
  <ul class="collapse">
  <li><a href="#the-estimated-itr" id="toc-the-estimated-itr" class="nav-link" data-scroll-target="#the-estimated-itr">The estimated ITR</a></li>
  <li><a href="#the-itr-in-the-context-of-outcome" id="toc-the-itr-in-the-context-of-outcome" class="nav-link" data-scroll-target="#the-itr-in-the-context-of-outcome">The ITR in the context of outcome</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#how-to-apply-the-pm-methods-to-your-own-data" id="toc-how-to-apply-the-pm-methods-to-your-own-data" class="nav-link" data-scroll-target="#how-to-apply-the-pm-methods-to-your-own-data">How to apply the PM methods to your own data?</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Example code of the simulations conducted in Jiang et al.&nbsp;2024</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Phoebe Jiang (phoebe.jiang@biogen.com) </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 16, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="manuscript" class="level1">
<h1>Manuscript</h1>
<p><strong>Impact of treatment effect heterogeneity on the estimation of individualized treatment rules (Authors: Xiaotong Jiang, Gabrielle Simoneau, Bora Youn, Fabio Pellegrini, Carl de Moor, Thomas Debray, Changyu Shen)</strong></p>
<ul>
<li><p><strong>Background:</strong> There’s growing interest in tailoring treatment decisions to individual patient characteristics, but few studies have examined the implementation and performance of individualized treatment rules (ITRs) for count data.</p></li>
<li><p><strong>Objective:</strong> To compare ITR methods in randomized trials with count outcomes and explore the impact of sample size, magnitude, and distribution of heterogeneity of treatment effect (HTE) on the validity of treatment recommendations.</p></li>
<li><p><strong>Methods:</strong> We conducted a simulation study where patients with five covariates were randomized to receive one of two treatments. Four ITR methods were evaluated in terms of value function and accuracy. We also conducted a case study involving patients with multiple sclerosis.</p></li>
<li><p><strong>Results:</strong> All ITR methods performed better with larger sample size, substantial HTE, or fewer patients with equivalent treatments. Conversely, ITRs was inferior to fixed treatment strategies with small sample sizes or limited HTE. However, larger sample sizes can compensate for smaller HTEs and high HTEs can compensate for limited data. In the case study, we identified HTE and developed a tree-based ITR that outperformed fixed treatment recommendations.</p></li>
<li><p><strong>Conclusion:</strong> The performance of a precision medicine approach can be influenced by sample size and the magnitude and distribution of HTE, as well as the interactions between them.</p></li>
</ul>
</section>
<section id="how-to-run-the-simulations-described-in-the-paper-yourself" class="level1">
<h1>How to run the simulations described in the paper yourself?</h1>
<p>Below are the options that you can select and try:</p>
<ul>
<li><p>Methods:</p>
<ul>
<li><p><code>method</code> <span class="math inline">\(\in\)</span> <span class="math inline">\(\{\)</span><code>allA1</code>, <code>allA0</code>, <code>linear</code>, <code>poisson</code>, <code>dWOLS</code>, <code>listDTR2</code>, <code>boosting</code>, <code>twoReg</code>, <code>contrastReg</code><span class="math inline">\(\}\)</span></p></li>
<li><p>Packages used: <code>dWOLS</code> <a href="https://cran.r-project.org/web/packages/DTRreg/index.html">DTRreg</a>, <code>listDTR</code> <a href="https://CRAN.R-project.org/package=listdtr">listdtr</a>, <code>boosting</code> <a href="https://cran.r-project.org/web/packages/gbm/index.html">gbm</a>, <code>twoReg</code> and <code>contrastReg</code> <a href="https://smartdata-analysis-and-statistics.github.io/precmed/index.html">precmed</a></p></li>
</ul></li>
<li><p>Sample size:</p>
<ul>
<li><code>n</code> <span class="math inline">\(\in\)</span> <span class="math inline">\(\{\)</span><code>500</code>, <code>1000</code>, <code>2500</code>, <code>5000</code>, <code>10000</code><span class="math inline">\(\}\)</span> (can select multiple)</li>
</ul></li>
<li><p>Magnitude of HTE:</p>
<ul>
<li><code>magnitude</code> <span class="math inline">\(\in\)</span> <span class="math inline">\(\{\)</span><code>no</code>, <code>low</code>, <code>medium</code>, <code>high</code><span class="math inline">\(\}\)</span></li>
</ul></li>
<li><p>Distribution of HTE:</p>
<ul>
<li><code>distribution</code> <span class="math inline">\(\in\)</span> <span class="math inline">\(\{\)</span><code>symm 20x5</code>, <code>symm 10-15-50-15-10</code>, <code>symm 10-30-20-30-10</code>, <code>asymm 55-30-15</code>, <code>asymm 55-15-15-15</code> <span class="math inline">\(\}\)</span></li>
</ul></li>
</ul>
<p>There are other constants that you can change as well but not necessary:</p>
<ul>
<li><p><code>n.cv</code> - number of CV iterations</p></li>
<li><p><code>batch_size</code>- number of CV iterations in each batch (number of batches = <code>n.cv</code> / <code>batch_size</code>)</p></li>
<li><p><code>n.fold</code> - number of CV folds</p></li>
</ul>
<p>Note that it is recommended to use parallel programming or high performance clusters to run sample sizes higher than 2500 and/or more complex methods such as <code>boosting</code>, <code>listDTR2</code>, <code>twoReg</code>, and <code>contrastReg</code> due to long running time. The purpose of running CV iterations in batches is to allow parallelization.</p>
<section id="an-example" class="level2">
<h2 class="anchored" data-anchor-id="an-example">An Example</h2>
<p>Through a simplified example, we demonstrate</p>
<ol type="1">
<li><p>how to conduct the simulations with three sample sizes in batches (function <code>simmain()</code>), and</p></li>
<li><p>summarize the results to a dataset (function <code>simsummarize()</code>), which will then be visualized.</p></li>
</ol>
<p>This example is based on 10 CV iterations of the magnitude no HTE with subgroup distribution symm 20x5, split in 2 batches of size <code>batch_size</code> if parallelization can be used. The chosen sample sizes are 500, 1000, 2500 and the methods used here are allA1, allA0, linear, poisson.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Go through each sample size, batch, and method</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(n <span class="cf">in</span> ns){</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(ind <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.batch){</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (method <span class="cf">in</span> methods){</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"##############################"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"####n"</span>, n, <span class="st">", method"</span>, method, <span class="st">"##########"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"##############################"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">simmain</span>(<span class="at">main_path =</span> main_path, <span class="at">method =</span> method, <span class="at">n =</span> n,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">magnitude =</span> magnitude, <span class="at">distribution =</span> distribution,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">batch_ind =</span> ind, <span class="at">n.cv =</span> n.cv, <span class="at">batch_size =</span> batch_size)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simsummarize</span>(main_path, n, magnitude, distribution, <span class="at">n.cv =</span> n.cv, <span class="at">batch_size =</span> batch_size)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">simsummarize_alln</span>(main_path, ns, magnitude, distribution)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="result-visualization" class="level2">
<h2 class="anchored" data-anchor-id="result-visualization">Result visualization</h2>
<p>We follow the visualization strategies in this decision flowchart <span class="citation" data-cites="cebook">(<a href="#ref-cebook" role="doc-biblioref">Debray et al. 2025</a>)</span>. First, we evaluate the accuracy and agreement of the ITR itself, following the left branch. Next, we follow the right branch and look at how the ITR performs in terms of patient well-being by taking into account the expected patient outcome under the ITRs estimated by selected PM methods.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="flowchart.png" class="img-fluid figure-img" style="width:4in"></p>
<figcaption class="figure-caption">A decision flowchart summarizing what precision medicine results to present</figcaption>
</figure>
</div>
<section id="the-estimated-itr" class="level3">
<h3 class="anchored" data-anchor-id="the-estimated-itr">The estimated ITR</h3>
<p>Accuracy is a metric that quantifies how many estimated ITRs are the same as the true optimal ITRs. We only know the true optimal ITRs in simulated data where the true decision boundary is known. In this situation of no HTE, every patient’s optimal treatment is A1 so All A1 method is 100% accurate by definition. For the two PM methods, larger sample size increases the accuracy from 65% to 80% as sample size goes from 500 to 2500.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="runme_files/figure-html/results1-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Agreement is a metric that quantifies how two estimated ITRs agree with each other. This plot is useful if we don’t know the true optimal ITR. It looks like Poisson and linear methods have 85% agreement, where Poisson recommended A1 to 82% of the patients and linear recommended A1 to 78% of the patients. By definition, All A0 and All A1 should have 0 agreement.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="runme_files/figure-html/results2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="the-itr-in-the-context-of-outcome" class="level3">
<h3 class="anchored" data-anchor-id="the-itr-in-the-context-of-outcome">The ITR in the context of outcome</h3>
<p>To evaluate the ITR in the context of outcome, the value functions (function <code>plotV()</code>) of the estimated ITRs are calculated and summarized separately in line plots. Four methods are used here for the scenario where no HTE exists. Recall that value function is a metric to quantify how “good” the ITRs are. Lower value functions are more desirable because our outcome of interest is number of relapses (a negative event). Here are some main takeaways:</p>
<ul>
<li>All A0 and All A1 are fixed rules so the value functions do not change as sample size increases.<br>
</li>
<li>Poisson and linear regression methods have similar performance in terms of value function.</li>
<li>The PM methods can learn better and recommend better treatment rules as sample size increases.</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<p><img src="runme_files/figure-html/results3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The value function results shown above are true value functions due to the benefit of simulated data. In real practice, we also need to estimate the value function when the true decision boundary is unknown. The visualization below shows the difference between <span class="math inline">\(V(\hat{d})\)</span> and <span class="math inline">\(\hat{V}(\hat{d})\)</span>. It is expected that two layers of estimation creates a bigger uncertainty as the lengths of the error bars indicate. Larger sample size helps reduce the variance.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="runme_files/figure-html/results4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>
<section id="how-to-apply-the-pm-methods-to-your-own-data" class="level1">
<h1>How to apply the PM methods to your own data?</h1>
<p>This section is for those who are interested in giving it a try to your dataset. We will demonstrate with a simple example how to fit the model, calculate the estimates, and validate via a separate dataset.</p>
<p>Let us try a small example of 500 samples with medium-level HTE and asymmetric responder group profile (i.e., 55% high responders to A1, 30% moderatre responders to A1, 15% neutral). Here, we are using the doubly robust Contrast Regression method (<span class="citation" data-cites="yadlowsky2021estimation">(<a href="#ref-yadlowsky2021estimation" role="doc-biblioref">Yadlowsky et al. 2021</a>)</span>, <span class="citation" data-cites="precmed2023">(<a href="#ref-precmed2023" role="doc-biblioref">Tian, Jiang, and Simoneau 2023</a>)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify sample size, magnitude and distribution of HTE</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">convertParameters</span>(<span class="st">"medium"</span>, <span class="st">"asymm 55-30-15"</span>, <span class="at">verbose =</span> T)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify X and Y variables to be included in the model</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>categoricalvars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"female"</span>, <span class="st">"prevDMTefficacy"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>formatted_categoricalvars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"female"</span>, <span class="st">"prevDMTefficacy_Medium.and.high.efficacy"</span>, <span class="st">"prevDMTefficacy_None"</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>continuousvars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ageatindex_centered"</span>, <span class="st">"prerelapse_num"</span>, <span class="st">"premedicalcost"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>yvar <span class="ot">&lt;-</span> <span class="st">"postrelapse_num"</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate random datasets</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>traindata <span class="ot">&lt;-</span> <span class="fu">simdata</span>(<span class="at">n =</span> n, <span class="at">RCT =</span> RCT, <span class="at">beta =</span> params<span class="sc">$</span>beta, </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">percentiles =</span> params<span class="sc">$</span>percentiles, <span class="at">seed =</span> <span class="dv">2023</span>)<span class="sc">$</span>data </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>testdata <span class="ot">&lt;-</span> <span class="fu">simdata</span>(<span class="at">n =</span> n, <span class="at">RCT =</span> RCT, <span class="at">beta =</span> params<span class="sc">$</span>beta, </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">percentiles =</span> params<span class="sc">$</span>percentiles, <span class="at">seed =</span> <span class="dv">2024</span>)<span class="sc">$</span>data</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># bigdata &lt;- simdata(n = 10000, RCT = RCT, beta = params$beta, percentiles = params$percentiles, seed = 999)$data</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Format the training and testing data</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">format.countdata</span>(<span class="at">data =</span> traindata, </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>                         <span class="at">yvar =</span> yvar, </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>                         <span class="at">timevar =</span> <span class="st">"finalpostdayscount"</span>, </span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                         <span class="at">trtvar =</span> <span class="st">"trt"</span>, </span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                         <span class="at">xcontinuousvars =</span> <span class="fu">c</span>(continuousvars, <span class="st">"FUweight"</span>), </span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                         <span class="at">xcategoricalvars =</span> categoricalvars, </span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                         <span class="at">RCT =</span> T, <span class="at">imputation.method =</span> <span class="cn">NULL</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>traindata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> temp<span class="sc">$</span>y, <span class="at">trt =</span> <span class="fu">factor</span>(temp<span class="sc">$</span>trt), <span class="at">time =</span> <span class="fu">log</span>(temp<span class="sc">$</span>time), temp<span class="sc">$</span>x)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>traindata<span class="sc">$</span>trt <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(traindata<span class="sc">$</span>trt <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">format.countdata</span>(<span class="at">data =</span> testdata, </span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>                         <span class="at">yvar =</span> yvar, </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>                         <span class="at">timevar =</span> <span class="st">"finalpostdayscount"</span>, </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>                         <span class="at">trtvar =</span> <span class="st">"trt"</span>, </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>                         <span class="at">xcontinuousvars =</span> <span class="fu">c</span>(continuousvars, <span class="st">"FUweight"</span>), </span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>                         <span class="at">xcategoricalvars =</span> categoricalvars, </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>                         <span class="at">RCT =</span> T, <span class="at">imputation.method =</span> <span class="cn">NULL</span>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>testdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> temp<span class="sc">$</span>y, <span class="at">trt =</span> <span class="fu">factor</span>(temp<span class="sc">$</span>trt), <span class="at">time =</span> <span class="fu">log</span>(temp<span class="sc">$</span>time), temp<span class="sc">$</span>x)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>testdata<span class="sc">$</span>trt <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(testdata<span class="sc">$</span>trt <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate PS/IPTW (assuming randomized trials)</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>trainps <span class="ot">&lt;-</span> <span class="fu">mean</span>(traindata<span class="sc">$</span>trt)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>traindata <span class="ot">&lt;-</span> traindata <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ps =</span> trainps, <span class="at">iptw =</span> <span class="fu">ifelse</span>(trt <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>ps, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">-</span> ps)))</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>testdata <span class="ot">&lt;-</span> testdata <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ps =</span> trainps, <span class="at">iptw =</span> <span class="fu">ifelse</span>(trt <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>ps, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">-</span> ps)))</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Implement the contrast Regression method    </span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">itrLuDR</span>(<span class="at">traindata =</span> traindata,</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>                    <span class="at">testdata =</span> testdata,</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>                    <span class="at">categoricalvars =</span> formatted_categoricalvars,</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>                    <span class="at">continuousvars =</span> continuousvars,</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>                    <span class="at">RCT =</span> T,</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>                    <span class="at">tree.depth =</span> <span class="dv">2</span>,</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n.trees =</span> <span class="dv">100</span>,</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Kfold =</span> <span class="dv">5</span>,</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>                    <span class="at">B =</span> <span class="dv">3</span>,</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>                    <span class="at">seed.cf =</span> <span class="dv">3</span>,</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>                    <span class="at">plot.gbmperf =</span> F,</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>                    <span class="at">sim.big =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The results of each PM method are saved as a list with name <code>results</code> and it contains two kinds of outputs:</p>
<ul>
<li><code>dhat</code>: the estimated ITR (where 0 means recommending A0 and 1 means recommending A1) for each subject; a vector of 0/1 values with size <span class="math inline">\(n\)</span></li>
<li><code>vhat.dhat</code>: numerator (<code>U</code>) and denominator (<code>W</code>) component of the value function estimate as well as intermediate components of the variance estimator (sumRj2 and <code>sumRj2.mean</code>); a list of 4 elements</li>
</ul>
<p>Below are the results from the contrast regression method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(results<span class="sc">$</span>valueContrastReg<span class="sc">$</span>dhat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  0   1 
204 296 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>valueContrastReg<span class="sc">$</span>vhat.dhat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$U
[1] 128.4225

$W
[1] 627.3908

$sumRj2
[1] 0.03584947

$sumRj2.mean
[1] 8962.368</code></pre>
</div>
</div>
<p>The estimated value function is <code>results$valueContrastReg$vhat.dhat$U / results$valueContrastReg$vhat.dhat$W</code> = 0.2.</p>
<p>For demonstration purpose, the model was not trained for very long. More optimal results might be generated with a longer training period, which has a trade-off between computation burden and model performance.</p>
</section>
<section id="references" class="level1 unnumbered">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-cebook" class="csl-entry" role="listitem">
Debray, Thomas et al. 2025. <em>Comparative Effectiveness and Personalized Medicine Using Real-World Data</em>. <a href="https://smartdata-analysis-and-statistics.github.io/time4stats/">https://smartdata-analysis-and-statistics.github.io/time4stats/</a>.
</div>
<div id="ref-precmed2023" class="csl-entry" role="listitem">
Tian, Lu, Xiaotong Jiang, and Gabrielle Simoneau. 2023. <em>Precmed: Precision Medicine</em>. <a href="https://smartdata-analysis-and-statistics.github.io/precmed/">https://smartdata-analysis-and-statistics.github.io/precmed/</a>.
</div>
<div id="ref-yadlowsky2021estimation" class="csl-entry" role="listitem">
Yadlowsky, Steve, Fabio Pellegrini, Federica Lionetto, Stefan Braune, and Lu Tian. 2021. <span>“Estimation and Validation of Ratio-Based Conditional Average Treatment Effects Using Observational Data.”</span> <em>Journal of the American Statistical Association</em> 116 (533): 335–52.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>